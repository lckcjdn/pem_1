# 双分割头MaskFormer基础配置文件
# 包含所有必要的默认配置项，作为其他配置的基础

MODEL:
  BACKBONE:
    FREEZE_AT: 0
    NAME: "build_resnet_backbone"
  WEIGHTS: ""
  PIXEL_MEAN: [123.675, 116.280, 103.530]
  PIXEL_STD: [58.395, 57.120, 57.375]
  RESNETS:
    DEPTH: 50
    STEM_TYPE: "basic"
    STEM_OUT_CHANNELS: 64
    STRIDE_IN_1X1: False
    OUT_FEATURES: ["res2", "res3", "res4", "res5"]
    NORM: "BN"
    RES5_MULTI_GRID: [1, 1, 1]
  META_ARCHITECTURE: "DoubleMaskFormer"
  DOUBLE_MASK_FORMER:
    # PIXEL_DECODER配置
    PIXEL_DECODER:
      NAME: "PEM_Pixel_Decoder"
      IN_FEATURES: ["res2", "res3", "res4", "res5"]
      PROJECT_FEATURES: ["res2"]
      PROJECT_CHANNELS: [48]
      CONVS_DIM: 128
      COMMON_STRIDE: 4
      NORM: "BN"
      TRANSFORMER_ENC_LAYERS: 6
      ASPP_CHANNELS: 256
      ASPP_DILATIONS: [6, 12, 18]
      ASPP_DROPOUT: 0.1
      USE_DEPTHWISE_SEPARABLE_CONV: False
    # 通用分割头配置模板
    HEAD1:
      NAME: "DoubleMaskFormerHead"
      NUM_CLASSES: 16  # 默认值，可在扩展配置中修改
      MASK_DIM: 256
      HIDDEN_DIM: 256
      NHEADS: 8
      DIM_FEEDFORWARD: 2048
      PRE_NORM: True
      ENFORCE_INPUT_PROJ: True
      NORM: "BN"
      TRANSFORMER_IN_FEATURE: "multi_scale_pixel_decoder"
      CLASS_WEIGHT: 2.0
      MASK_WEIGHT: 5.0
      DICE_WEIGHT: 5.0
      TRAIN_NUM_POINTS: 12544
      NO_OBJECT_WEIGHT: 0.1
      DEEP_SUPERVISION: True
      DEC_LAYERS: 7
      OVERSAMPLE_RATIO: 3.0
      IMPORTANCE_SAMPLE_RATIO: 0.75
      NUM_OBJECT_QUERIES: 100
      DROPOUT: 0.0
      ENC_LAYERS: 0
      CLASS_WEIGHTS: []  # 类别权重，默认为空
    # 分割头2配置
    HEAD2:
      NAME: "DoubleMaskFormerHead"
      NUM_CLASSES: 9  # 默认值，可在扩展配置中修改
      MASK_DIM: 256
      HIDDEN_DIM: 256
      NHEADS: 8
      DIM_FEEDFORWARD: 2048
      PRE_NORM: True
      ENFORCE_INPUT_PROJ: True
      NORM: "BN"
      TRANSFORMER_IN_FEATURE: "multi_scale_pixel_decoder"
      CLASS_WEIGHT: 2.0
      MASK_WEIGHT: 5.0
      DICE_WEIGHT: 5.0
      TRAIN_NUM_POINTS: 12544
      NO_OBJECT_WEIGHT: 0.1
      DEEP_SUPERVISION: True
      DEC_LAYERS: 7
      OVERSAMPLE_RATIO: 3.0
      IMPORTANCE_SAMPLE_RATIO: 0.75
      NUM_OBJECT_QUERIES: 100
      DROPOUT: 0.0
      ENC_LAYERS: 0
    # 融合配置
    FUSION:
      METHOD: "weighted_sum"
      HEAD1_WEIGHT: 0.6
      HEAD2_WEIGHT: 0.4
    # 测试配置
    TEST:
      OBJECT_MASK_THRESHOLD: 0.8
      OVERLAP_THRESHOLD: 0.8
      SEM_SEG_POSTPROCESSING_BEFORE_INFERENCE: False
      PANOPTIC_ON: False
      INSTANCE_ON: False
      SEMANTIC_ON: True
    SIZE_DIVISIBILITY: 32

DATASETS:
  # 默认数据集配置
  TRAIN: []
  TEST: []
  PRECOMPUTED_PROPOSAL_TOPK_TEST: 1000
  PRECOMPUTED_PROPOSAL_TOPK_TRAIN: 2000
  PROPOSAL_FILES_TEST: []
  PROPOSAL_FILES_TRAIN: []

SOLVER:
  # 默认优化器配置
  IMS_PER_BATCH: 3
  BASE_LR: 0.0007
  BASE_LR_END: 0.0
  MAX_ITER: 150000
  WARMUP_FACTOR: 1.0
  WARMUP_ITERS: 0
  WEIGHT_DECAY: 0.05
  OPTIMIZER: "ADAMW"
  LR_SCHEDULER_NAME: "WarmupCosineLR"
  BACKBONE_MULTIPLIER: 0.1
  HEAD1_LR_MULTIPLIER: 1.0
  HEAD2_LR_MULTIPLIER: 1.0
  GRADIENT_ACCUMULATION_STEPS: 1  # 梯度累积步数，默认为1
  CLIP_GRADIENTS:
    ENABLED: True
    CLIP_TYPE: "full_model"
    CLIP_VALUE: 0.01
    NORM_TYPE: 2.0
  AMP:
    ENABLED: True
    INITIAL_SCALE_POWER: 32.0  # 确保包含此配置项
  CHECKPOINT_PERIOD: 5000

INPUT:
  # 默认输入配置
  MIN_SIZE_TRAIN: [512, 614, 716, 819, 921, 1024, 1126, 1228, 1331, 1433, 1536, 1638, 1740, 1843, 1945, 2048]
  MIN_SIZE_TRAIN_SAMPLING: "choice"
  MIN_SIZE_TEST: 1024
  MAX_SIZE_TRAIN: 4096
  MAX_SIZE_TEST: 2048
  CROP:
    ENABLED: True
    TYPE: "absolute"
    SIZE: (512, 1024)
    SINGLE_CATEGORY_MAX_AREA: 1.0
  COLOR_AUG_SSD: True
  SIZE_DIVISIBILITY: -1
  FORMAT: "RGB"
  DATASET_MAPPER_NAME: "double_mask_former_semantic"
  RANDOM_FLIP: "horizontal"

TEST:
  # 默认测试配置
  EVAL_PERIOD: 5000
  AUG:
    ENABLED: False
    MIN_SIZES: [512, 768, 1024, 1280, 1536, 1792]
    MAX_SIZE: 4096
    FLIP: True
  AMP:
    ENABLED: True  # 推理时启用AMP

DATALOADER:
  # 默认数据加载器配置
  ASPECT_RATIO_GROUPING: True
  FILTER_EMPTY_ANNOTATIONS: True
  NUM_WORKERS: 4
  REPEAT_SQRT: True
  REPEAT_THRESHOLD: 0.0
  SAMPLER_TRAIN: "TrainingSampler"
  PIN_MEMORY: True

# 语义分割配置
SEGMENTATION:
  # 默认类别权重配置
  APOLLO_CLASS_WEIGHTS: []

# 训练配置
TRAINING:
  # 冻结配置
  FREEZE_BACKBONE: False
  FREEZE_HEAD2: False
  FREEZE_PIXEL_DECODER: False
  FREEZE_TRANSFORMER_DECODER: False
  # 训练配置
  TRAIN_HEAD1: True
  TRAIN_HEAD2: True

# 优化配置
OPTIMIZATION:
  # 梯度累积配置
  GRADIENT_ACCUMULATION:
    ENABLED: False
    STEPS: 1
  # 内存优化
  MEMORY_OPTIMIZATION:
    ENABLED: False
    MAX_SPLIT_SIZE_MB: 128

# 输出目录（默认值，应在扩展配置中覆盖）
OUTPUT_DIR: "output/default"

VERSION: 2