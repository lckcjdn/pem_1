# Apollo数据集微调扩展配置文件
# 基于基础配置，只包含需要覆盖的特定设置

# 继承基础配置
_BASE_: "base_double_maskformer.yaml"

# 模型配置修改
MODEL:
  WEIGHTS: "output/output_vistas/model_final.pth"
  DOUBLE_MASK_FORMER:
    # Head 1配置 (Apollo数据集)
    HEAD1:
      NUM_CLASSES: 15  # Apollo数据集类别数
      # Apollo数据集类别权重
      CLASS_WEIGHTS: [1.0, 2.0, 2.0, 2.0, 2.0, 2.0, 2.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0]
    # Head 2配置保持不变，但将被冻结
    HEAD2:
      NUM_CLASSES: 8  # 保持一致的类别数

# 数据集配置
DATASETS:
  TRAIN: ["cityscapes_apollo_sem_seg_train"]
  TEST: ["cityscapes_apollo_sem_seg_val"]

# 微调优化器配置
SOLVER:
  # 微调时的参数设置
  IMS_PER_BATCH: 2 # 减小批大小以节省内存
  BASE_LR: 0.0001  # 较低的学习率用于微调
  MAX_ITER: 50000  # 微调的迭代次数
  WARMUP_FACTOR: 0.01
  WARMUP_ITERS: 5000  # 较长的预热阶段
  WEIGHT_DECAY: 0.01
  LR_SCHEDULER_NAME: "WarmupMultiStepLR"
  BACKBONE_MULTIPLIER: 0.0  # 冻结骨干网络
  HEAD1_LR_MULTIPLIER: 1.0  # 分割头1正常学习率
  HEAD2_LR_MULTIPLIER: 0.0  # 冻结分割头2
  GRADIENT_ACCUMULATION_STEPS: 4  # 使用梯度累积
  CLIP_GRADIENTS:
    ENABLED: True
    CLIP_TYPE: "norm"
    CLIP_VALUE: 1.0
    NORM_TYPE: 2.0
  CHECKPOINT_PERIOD: 5000

# 输入配置修改
INPUT:
  MIN_SIZE_TRAIN: [640, 672, 704, 736, 768, 800]
  MIN_SIZE_TRAIN_SAMPLING: "choice"

# 测试配置修改
TEST:
  EVAL_PERIOD: 10000

# 数据加载器配置
DATALOADER:
  NUM_WORKERS: 2  # 减少worker数量以节省内存
  SAMPLER_TRAIN: "RepeatFactorTrainingSampler"  # 使用RepeatFactorTrainingSampler处理类别不平衡
  REPEAT_THRESHOLD: 0.001  # 对稀有类别进行过采样

# 训练配置
TRAINING:
  # 冻结配置
  FREEZE_BACKBONE: True  # 冻结骨干网络
  FREEZE_HEAD2: True  # 冻结分割头2
  FREEZE_PIXEL_DECODER: True  # 冻结像素解码器
  FREEZE_TRANSFORMER_DECODER: True  # 冻结Transformer解码器
  # 只训练分割头1
  TRAIN_HEAD1: True
  TRAIN_HEAD2: False

# 优化配置
OPTIMIZATION:
  # 梯度累积配置
  GRADIENT_ACCUMULATION:
    ENABLED: True
    STEPS: 4
  # 内存优化
  MEMORY_OPTIMIZATION:
    ENABLED: True
    MAX_SPLIT_SIZE_MB: 128  # CUDA内存分配优化

# 输出目录
OUTPUT_DIR: "output/apo_finetune"